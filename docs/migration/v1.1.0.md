# Migration to v1.1.0

These are the steps to migrate from `v1.0.1` to `v1.1.0`.

## Update CI Documentation Check

Update `.github/workflows/rust.yml` to use `--no-deps` for faster documentation builds:

```diff
      - name: Check documentation is valid
        if: github.event_name == 'pull_request' || startsWith(github.ref, 'refs/tags/')
        working-directory: src
        env:
          RUSTDOCFLAGS: "-D warnings"
-       run: cargo doc --workspace --all-features --document-private-items --target ${{ matrix.target }}
+       run: cargo doc --no-deps --workspace --all-features --document-private-items --target ${{ matrix.target }}
```

## Add Verification Scripts

Create `.cargo/verify.sh` for Linux/macOS:

```bash
#!/usr/bin/env bash
# Post-change verification script
# All steps must pass without warnings
# Keep in sync with verify.ps1

set -e

echo "Building..."
cargo build --workspace --all-features --all-targets --quiet

echo "Testing..."
cargo test --workspace --all-features --quiet

echo "Clippy..."
cargo clippy --workspace --all-features --quiet -- -D warnings

echo "Docs..."
RUSTDOCFLAGS="-D warnings" cargo doc --workspace --all-features --no-deps --document-private-items --quiet

echo "Formatting..."
cargo fmt --all

echo "Publish dry-run..."
cargo publish --dry-run --quiet --workspace

echo "All checks passed!"
```

Create `.cargo/verify.ps1` for Windows:

```powershell
# Post-change verification script
# All steps must pass without warnings
# Keep in sync with verify.sh

$ErrorActionPreference = "Stop"

Write-Host "Building..."
cargo build --workspace --all-features --all-targets --quiet

Write-Host "Testing..."
cargo test --workspace --all-features --quiet

Write-Host "Clippy..."
cargo clippy --workspace --all-features --quiet -- -D warnings

Write-Host "Docs..."
$env:RUSTDOCFLAGS = "-D warnings"
cargo doc --workspace --all-features --no-deps --document-private-items --quiet

Write-Host "Formatting..."
cargo fmt --all

Write-Host "Publish dry-run..."
cargo publish --dry-run --quiet --workspace

Write-Host "All checks passed!"
```

## Update AGENTS.md

Replace the inline verification commands in `src/AGENTS.md`:

```diff
  # Post-Change Verification

- All must pass without warnings:
-
- ```bash
- cargo build --workspace --all-features --all-targets --quiet
- cargo test --workspace --all-features --quiet
- cargo clippy --workspace --all-features --quiet -- -D warnings
- cargo doc --workspace --all-features --quiet
- cargo fmt --all --quiet
- cargo publish --dry-run --quiet
- ```
+ Always run `.cargo/verify.sh` (or `.cargo/verify.ps1` on Windows) after changing code.
```

## Add Path Filters to CI Workflow

Update `.github/workflows/rust.yml` to only run CI when source code changes:

```diff
 on:
   push:
     branches: [main]
     tags:
       - "*"
+    paths:
+      - "src/**"
   pull_request:
     branches: [main]
+    paths:
+      - "src/**"
   workflow_dispatch:
```

This prevents unnecessary CI runs for documentation, configuration, or other non-code changes. Tag pushes and manual dispatch remain unaffected.

## Disable Duplicate Caching (CLI Projects Only)

If your project includes a CLI, add `use-cache: false` to the CLI build step:

```diff
       - name: Build CLI Binary
         uses: Reloaded-Project/devops-rust-lightweight-binary@v1
         with:
           target: {% raw %}${{ matrix.target }}{% endraw %}
           use-pgo: {% raw %}${{ matrix.use-pgo && env.build-with-pgo }}{% endraw %}
           use-cross: {% raw %}${{ matrix.use-cross }}{% endraw %}
           build-library: false
           run-tests-and-coverage: false
           rust-project-path: src/cli
           workspace-path: src
           pgo-project-path: src/{{project-name}}
+          use-cache: false
```

This prevents redundant caching since the previous test/coverage step already cached the workspace.

## Enable Auto-Delete Merged Branches

Enable automatic deletion of merged branches for your repository:

```bash
gh repo edit --delete-branch-on-merge
```

Or via UI: **Settings > General > check "Automatically delete head branches"**

## Update Template Version Marker

Update `.github/template-version.txt` to reflect the new version:

```diff
- reloaded-templates-rust:1.0.1
+ reloaded-templates-rust:1.1.0
```
